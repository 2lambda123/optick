#pragma once

#include "optick.config.h"

#if USE_OPTICK


#include "optick_common.h"
#include "optick_memory.h"
#include "optick_serialization.h"

#if !defined(OPTICK_ENABLE_SYMENGINE)
#if defined(OPTICK_MSVC)
#define OPTICK_ENABLE_SYMENGINE (USE_OPTICK)
#else
#define OPTICK_ENABLE_SYMENGINE (0)
#endif
#endif

namespace Optick
{
	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	struct Module
	{
		string path;
		void* address;
		size_t size;
		Module(const char* p, void* a, size_t s) : path(p), address(a), size(s) {}
	};
	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	struct Symbol
	{
		uint64 address;
		uint64 offset;
		wstring file;
		wstring function;
		uint32 line;
		Symbol()
			: address(0)
			, offset(0)
			, line(0)
		{}
	};
	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	OutputDataStream& operator<<(OutputDataStream& os, const Symbol * const symbol);
	OutputDataStream& operator<<(OutputDataStream& os, const Module& module);
	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
	typedef unordered_map<uint64, Symbol> SymbolCache;
	////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	class SymbolEngine
	{
	protected:
		SymbolCache cache;
		vector<Module> modules;
	public:
		virtual void UpdateModules() {}
		virtual const vector<Module>& GetModules() { return modules; }

		// Get Symbol from address
		virtual const Symbol* const GetSymbol(uint64 dwAddress);


		virtual ~SymbolEngine() {};

		static SymbolEngine* Get();


	};

}


#endif //USE_OPTICK